# Octopus CLI 项目任务管理

## 开发阶段划分

### Phase 1: 项目基础设置 (已完成)
- [x] 创建项目目录结构
- [x] 编写需求文档 (CLI 版本)
- [x] 建立任务管理体系
- [x] 更新为 CLI 架构设计

### Phase 2: Go CLI 项目初始化 (已完成)
- [x] 初始化 Git 仓库和开源准备
  - [x] `git init` 初始化仓库
  - [x] 创建 MIT License 文件
  - [x] 创建 .gitignore 文件
  - [x] 创建 README.md 项目介绍
- [x] 初始化 Go 模块 (`go mod init octopus-cli`)
- [x] 创建 CLI 项目结构
  - [x] `cmd/` - CLI 入口和命令 (简化为单文件结构)
  - [x] `internal/` - 内部包
  - [x] `pkg/` - 公共包  
  - [x] `configs/` - TOML 配置文件
- [x] 集成 Cobra CLI 框架
- [x] 设置基本的 Makefile
- [x] 设置 TDD 测试框架

### Phase 3: CLI 基础架构实现 (TDD 方式) (已完成)
- [x] 实现 CLI 命令结构 (测试先行)
  - [x] 编写根命令和子命令测试
  - [x] 根命令和子命令定义
  - [x] 编写命令行参数解析测试  
  - [x] 命令行参数解析
  - [x] 编写帮助信息测试
  - [x] 帮助信息和版本信息
- [x] 实现 TOML 配置管理器 (测试先行)
  - [x] 编写配置数据结构测试
  - [x] 定义数据结构
  - [x] 编写 TOML 配置文件读写测试
  - [x] TOML 配置文件读写
  - [x] 编写配置验证测试
  - [x] 配置验证逻辑
- [x] 实现基础服务管理 (测试先行)
  - [x] 编写进程管理器测试
  - [x] 进程管理器
  - [x] 编写守护进程测试
  - [x] 守护进程支持
  - [x] 编写 PID 文件管理测试
  - [x] PID 文件管理

### Phase 4: 核心代理功能实现 (TDD 方式) (已完成)
- [x] 实现 HTTP 代理服务器 (测试先行) (已完成)
  - [x] 编写基础 HTTP 服务器测试
  - [x] 基础 HTTP 服务器
  - [x] 编写请求拦截和转发测试
  - [x] 请求拦截和转发
  - [x] 编写响应处理测试
  - [x] 响应处理
- [x] 实现转发引擎 (测试先行) (已完成)
  - [x] 编写 API 请求转发逻辑测试
  - [x] API 请求转发逻辑
  - [x] 编写错误处理和重试测试
  - [x] 错误处理和重试
  - [x] 编写日志记录测试
  - [x] 日志记录
- [x] 实现配置切换功能 (测试先行) (已完成)
  - [x] 编写动态配置重载测试
  - [x] 动态配置重载
  - [x] 编写活跃配置管理测试
  - [x] 活跃配置管理

### Phase 5: CLI 命令实现 (TDD 方式) (已完成)
- [x] 服务管理命令 (测试先行)
  - [x] 编写 `octopus start` 测试 - 启动服务
  - [x] `octopus start` - 启动服务
  - [x] 编写 `octopus stop` 测试 - 停止服务
  - [x] `octopus stop` - 停止服务  
  - [x] 编写 `octopus status` 测试 - 状态查询
  - [x] `octopus status` - 状态查询
  - [ ] 编写 `octopus restart` 测试 - 重启服务 (不在 MVP 范围)
  - [ ] `octopus restart` - 重启服务 (不在 MVP 范围)
- [x] 配置管理命令 (测试先行)
  - [x] 编写 `octopus config list` 测试 - 列出配置
  - [x] `octopus config list` - 列出配置
  - [x] 编写 `octopus config add` 测试 - 添加配置
  - [x] `octopus config add` - 添加配置
  - [x] 编写 `octopus config remove` 测试 - 删除配置
  - [x] `octopus config remove` - 删除配置
  - [x] 编写 `octopus config switch` 测试 - 切换配置
  - [x] `octopus config switch` - 切换配置
  - [x] 编写 `octopus config show` 测试 - 显示配置详情
  - [x] `octopus config show` - 显示配置详情
- [x] 监控诊断命令 (测试先行)
  - [x] 编写 `octopus health` 测试 - 健康检查
  - [x] `octopus health` - 健康检查
  - [x] 编写 `octopus logs` 测试 - 日志查看
  - [x] `octopus logs` - 日志查看
  - [x] 编写 `octopus version` 测试 - 版本信息
  - [x] `octopus version` - 版本信息

### Phase 6: 用户体验优化 (已完成核心功能)
- [x] CLI 用户界面优化
  - [x] 便捷启动模式 (`octopus` 无参数直接启动)
  - [x] 智能配置文件管理 (自动使用 default.toml 或记住上次使用的配置)
  - [x] 状态查看功能 (`octopus config` 显示当前配置信息)
  - [ ] 交互式配置添加
  - [x] 彩色输出和格式化 (已完成表格对齐修复)
  - [ ] 进度指示器
- [x] 错误处理优化
  - [x] 用户友好的错误信息
  - [x] 配置文件不存在时自动回退到默认配置
  - [x] API 切换时自动验证 API 配置存在
  - [ ] 错误恢复建议
  - [ ] 调试模式支持
- [x] 配置管理优化
  - [x] 可移植配置系统 (所有文件保存在二进制同目录)
  - [x] 配置状态持久化 (settings.toml 记录当前配置文件)
  - [x] API 即时切换 (自动重启守护进程应用新配置)
  - [ ] 配置模板生成
  - [ ] 配置验证和提示
  - [ ] 配置备份恢复
- [x] 构建系统优化
  - [x] 多平台构建支持 (Windows, macOS-x64, macOS-ARM64, Linux)
  - [x] 版本化命名规则 (v0.0.1-platform-YYYYMMDD.git_sha)

### Phase 7: 健康检查和监控 (已完成基础功能)
- [x] API 健康检查功能
  - [x] 端点可用性检查 (`octopus health` 命令)
  - [x] 响应时间监控
  - [x] 状态报告生成
- [x] 日志和监控系统
  - [x] 结构化日志 (时间戳 + 日志级别 + 消息)
  - [x] 请求转发日志 (记录源 IP、目标 API、转发结果)
  - [x] 配置变更日志 (记录 API 切换和守护进程重启)
  - [x] 可移植日志文件 (logs/octopus.log)
  - [ ] 请求统计
  - [ ] 性能指标收集
- [ ] 管理 API 接口 (可选)
  - [ ] RESTful 管理接口
  - [ ] 远程配置管理

### Phase 8: 测试和文档
- [ ] 单元测试
  - [ ] CLI 命令测试
  - [ ] 配置管理器测试
  - [ ] 转发引擎测试
  - [ ] 进程管理器测试
- [ ] 集成测试
  - [ ] 端到端 CLI 测试
  - [ ] 代理功能测试
  - [ ] 配置切换测试
- [ ] 文档完善
  - [ ] CLI 命令文档
  - [ ] 用户使用指南
  - [ ] 配置文件说明
  - [ ] 故障排除指南

### Phase 9: 发布准备
- [ ] 构建和打包
  - [ ] 多平台构建脚本
  - [ ] 二进制文件打包
  - [ ] 安装脚本生成
- [ ] 发布流程
  - [ ] 版本管理
  - [ ] 发布说明
  - [ ] 分发渠道准备

## CLI 命令开发优先级

**✅ High Priority (MVP 必需) - 已完成:**
1. ✅ `octopus start/stop/status` - 基础服务管理
2. ✅ `octopus config add/list/switch` - 核心配置管理
3. ✅ 基础代理转发功能
4. ✅ 便捷启动模式 (`octopus` 无参数自动启动)
5. ✅ 智能配置管理 (自动记住配置文件状态)

**✅ Medium Priority - 已完成:**
1. ✅ `octopus config remove/show` - 完整配置管理
2. ✅ `octopus health` - 健康检查
3. ✅ `octopus logs` - 日志查看
4. ✅ 配置验证和错误处理
5. ✅ API 即时切换 (自动重启守护进程)
6. ✅ 可移植配置系统

**⏳ Low Priority - 待开发:**
1. `octopus restart` - 便利功能
2. `octopus config edit` - 高级配置
3. 管理 API 接口
4. 监控和统计功能

## 开发规范

### 开发方法论 - TDD (Test-Driven Development)
本项目采用 **测试驱动开发 (TDD)** 方法论，强调测试优先：

#### TDD 开发流程
1. **Red**: 编写失败的测试用例
2. **Green**: 编写最小可行代码使测试通过
3. **Refactor**: 重构代码保持测试通过

#### TDD 实践原则
- 任何新功能开发前必须先编写测试
- 测试用例要覆盖正常流程和边界条件
- 保持测试代码的可读性和可维护性
- 每个 commit 都应该包含对应的测试
- 持续运行测试确保回归

### CLI 设计原则
- 命令结构清晰，易于记忆
- 提供丰富的帮助信息
- 支持常用的标志参数 (--verbose, --config, --help)
- 错误信息友好且具有指导性

### 代码规范
- 使用 `gofmt` 和 `goimports` 格式化代码
- 遵循 Go 命名约定
- CLI 命令使用 Cobra 框架
- 配置管理使用标准 TOML 库
- 严格遵循 TDD 开发流程

### 配置管理规范  
- TOML 格式配置文件
- 支持配置文件优先级
- 敏感信息安全存储
- 配置变更原子操作

### 测试规范 (TDD 重点)
- **单元测试**: 每个函数/方法都要有对应测试
- **集成测试**: CLI 命令端到端测试
- **测试覆盖率**: 目标 > 90% (比之前提高)
- **测试命名**: 使用 `TestFunctionName_Scenario_ExpectedBehavior` 格式
- **表驱动测试**: 使用表格驱动测试处理多种场景
- **Mock 和 Stub**: 模拟外部依赖 (API 调用、文件系统)
- **测试金字塔**:
  - 单元测试 (70%): 快速、独立、可靠
  - 集成测试 (20%): 组件间交互
  - 端到端测试 (10%): 完整用户场景

### Git 和开源规范
- 使用语义化提交信息 (Conventional Commits)
- 功能开发使用分支 (feature/功能名)
- Pull Request 必须包含测试
- 代码审查必须通过所有测试
- MIT 开源许可证

## 技术债务管理

### 当前技术债务
- [ ] 错误处理标准化
- [ ] 日志格式统一
- [ ] 配置验证完善
- [ ] 测试覆盖率提升

### 性能优化
- [ ] HTTP 客户端连接池
- [ ] 配置热重载优化
- [ ] 内存使用优化
- [ ] 启动时间优化

## 里程碑

1. ✅ **CLI 框架版本** - 基础 CLI 命令和配置管理 (Phase 2-3) [已完成]
2. ✅ **MVP 版本** - 基本代理和配置切换功能 (Phase 4-5) [已完成]
3. ✅ **Beta 版本** - 完整 CLI 功能和用户体验优化 (Phase 6-7) [核心功能已完成]
4. ⏳ **正式版本** - 完善测试和文档 (Phase 8) [测试覆盖待完善]
5. ⏳ **发布版本** - 可分发安装 (Phase 9) [待开发]

## 质量门禁

### ✅ MVP 版本要求 - 已完成
- ✅ 基础 CLI 命令正常工作
- ✅ TOML 配置文件读写正常
- ✅ 代理转发功能正常
- ✅ 配置切换功能正常

### ✅ Beta 版本要求 - 已完成
- ✅ 所有 CLI 命令实现
- ✅ 错误处理完善
- ✅ 用户体验友好 (便捷启动、智能配置管理、可移植部署)
- ✅ 基本测试覆盖

### 🆕 当前版本特色功能
- ✅ **便捷启动**: `octopus` 无参数直接启动，无需指定配置文件
- ✅ **智能配置**: 自动记住当前使用的配置文件，支持无缝切换
- ✅ **即时生效**: API 切换后自动重启守护进程，立即应用新配置
- ✅ **完整日志**: 记录所有请求转发、API 切换、服务重启事件
- ✅ **可移植部署**: 所有配置文件、日志、PID 文件保存在二进制同目录
- ✅ **健壮错误处理**: 配置文件不存在时自动回退，API 不存在时提示错误
- ✅ **彩色输出**: 美观的彩色表格和状态显示，支持 `--no-color` 选项，已修复表格对齐问题
- ✅ **多平台构建**: 支持 Windows, macOS (x64/ARM64), Linux 平台构建
- ✅ **版本化发布**: 规范的版本命名 `v0.0.1-platform-YYYYMMDD.git_sha`

### 正式版本要求
- 完整测试覆盖
- 文档完善
- 性能满足要求
- 安全审计通过